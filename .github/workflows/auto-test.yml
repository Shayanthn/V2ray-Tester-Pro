name: Auto Test & Update Subscriptions

on:
  schedule:
    # Run every 2 hours
    - cron: '0 */2 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main

jobs:
  test-and-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download Xray Core
        run: |
          # Fetch latest Xray version using Python (more robust)
          python -c "
          import requests
          import os
          import sys
          
          try:
              print('Fetching latest Xray version tag...')
              response = requests.get('https://api.github.com/repos/XTLS/Xray-core/releases/latest', timeout=10)
              response.raise_for_status()
              tag = response.json()['tag_name']
              print(f'Latest version: {tag}')
              with open('xray_version.txt', 'w') as f:
                  f.write(tag)
          except Exception as e:
              print(f'Error fetching version: {e}')
              # Fallback to a known stable version
              default_ver = 'v1.8.23' 
              print(f'Using fallback version: {default_ver}')
              with open('xray_version.txt', 'w') as f:
                  f.write(default_ver)
          "
          
          XRAY_VERSION=$(cat xray_version.txt)
          echo "Determined Xray version: $XRAY_VERSION"
          
          echo "Downloading Xray Core $XRAY_VERSION..."
          
          # Download with retry and better error handling
          if ! wget -q --show-progress --tries=3 --timeout=30 "https://github.com/XTLS/Xray-core/releases/download/${XRAY_VERSION}/Xray-linux-64.zip" -O Xray-linux-64.zip; then
            echo "Failed to download Xray Core ${XRAY_VERSION}. Retrying with absolute fallback v1.8.4..."
            wget -q --show-progress --tries=3 --timeout=30 "https://github.com/XTLS/Xray-core/releases/download/v1.8.4/Xray-linux-64.zip" -O Xray-linux-64.zip
          fi
          
          # Check if file exists and is non-empty
          if [ ! -s Xray-linux-64.zip ]; then
            echo "Downloaded file is empty or does not exist."
            ls -lh Xray-linux-64.zip || echo "File not found"
            exit 1
          fi
          
          # Check if file is valid zip
          if ! unzip -t Xray-linux-64.zip; then
            echo "Downloaded file is not a valid zip. File size: $(stat -f%z Xray-linux-64.zip 2>/dev/null || stat -c%s Xray-linux-64.zip)"
            echo "First 500 bytes of file:"
            head -c 500 Xray-linux-64.zip
            exit 1
          fi
          
          unzip -o Xray-linux-64.zip
          chmod +x xray
          ./xray version
      
      - name: Run V2Ray Tester (CLI Mode)
        timeout-minutes: 90
        run: |
          python main.py --cli --max-configs 200
        env:
          PYTHONUNBUFFERED: 1
      
      - name: Generate Statistics
        run: |
          python -c "
          import json
          import os
          from datetime import datetime
          
          if os.path.exists('results.json'):
              with open('results.json', 'r') as f:
                  results = json.load(f)
              
              stats = {
                  'total_tested': len(results),
                  'total_working': len([r for r in results if r]),
                  'avg_ping': sum(r['ping'] for r in results if r) / len([r for r in results if r]) if results else 0,
                  'avg_download': sum(r['download_speed'] for r in results if r) / len([r for r in results if r]) if results else 0,
                  'last_updated': datetime.now().isoformat(),
                  'protocols': {}
              }
              
              for result in results:
                  if result:
                      protocol = result['protocol']
                      stats['protocols'][protocol] = stats['protocols'].get(protocol, 0) + 1
              
              with open('subscriptions/stats.json', 'w') as f:
                  json.dump(stats, f, indent=2)
              
              print(f'‚úÖ Tested: {stats[\"total_tested\"]} | Working: {stats[\"total_working\"]}')
          "
      
      - name: Update badge data
        run: |
          python -c "
          import json
          import os
          
          if os.path.exists('subscriptions/stats.json'):
              with open('subscriptions/stats.json', 'r') as f:
                  stats = json.load(f)
              
              os.makedirs('badges', exist_ok=True)
              
              # Create badge JSON for shields.io
              badge_data = {
                  'schemaVersion': 1,
                  'label': 'Working Nodes',
                  'message': str(stats['total_working']),
                  'color': 'brightgreen'
              }
              
              with open('badges/nodes.json', 'w') as f:
                  json.dump(badge_data, f)
          "
      
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add subscriptions/ badges/ results.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "üîÑ Auto-update: $(date +'%Y-%m-%d %H:%M:%S')" && git push)
      
      - name: Create release on major update
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: auto-${{ github.run_number }}
          name: Auto-Release ${{ github.run_number }}
          body: |
            **Automated Release**
            
            üìä Statistics:
            - Check `subscriptions/stats.json` for details
            
            üì• Quick Import:
            - [Base64 Subscription](https://raw.githubusercontent.com/${{ github.repository }}/main/subscriptions/subscription.txt)
            - [Clash Config](https://raw.githubusercontent.com/${{ github.repository }}/main/subscriptions/clash.yaml)
          files: |
            subscriptions/subscription.txt
            subscriptions/clash.yaml
            subscriptions/configs.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Workflow failed! Check logs for details."
          # You can add Telegram notification here using your bot
