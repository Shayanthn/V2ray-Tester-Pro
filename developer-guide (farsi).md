
# 📖 V2Ray/Xray Enterprise - راهنمای توسعه‌دهندگان

سلام، همکار توسعه‌دهنده\! 👋

به اتاق فرمان **V2Ray/Xray Enterprise Tester** خوش آمدید. ما بسیار هیجان‌زده‌ایم که شما علاقه‌مند به نگاهی به پشت صحنه و شاید حتی کمک کردن به پروژه هستید. این راهنما طراحی شده تا شما را با معماری پروژه، اجزای اصلی و روند توسعه آشنا کند.

[](https://github.com/Shayanthn/V2ray-Tester-Pro)
[](https://www.google.com/search?q=https://github.com/Shayanthn/V2ray-Tester-Pro/blob/main/LICENSE)
[](https://www.python.org/downloads/)
[](https://riverbankcomputing.com/software/pyqt/)
[](https://github.com/Shayanthn/V2ray-Tester-Pro/tree/developer-mode)

-----

## فهرست مطالب

  * [🚀 فلسفه پروژه](https://www.google.com/search?q=%23-project-philosophy)
  * [🏗️ معماری سطح بالا](https://www.google.com/search?q=%23%25EF%25B8%258F-high-level-architecture)
  * [🧩 بررسی عمیق اجزای اصلی](https://www.google.com/search?q=%23-core-components-deep-dive)
  * [🛠️ راه‌اندازی محیط توسعه](https://www.google.com/search?q=%23%25EF%25B8%258F-setting-up-your-dev-environment)
  * [🔄 گردش کار تست](https://www.google.com/search?q=%23-the-testing-workflow)
  * [🧠 مفاهیم کلیدی و الگوهای طراحی](https://www.google.com/search?q=%23-key-concepts--design-patterns)
  * [🤝 چگونه مشارکت کنیم](https://www.google.com/search?q=%23-how-to-contribute)
  * [🗺️ نقشه راه آینده](https://www.google.com/search?q=%23%25EF%25B8%258F-future-roadmap)
  * [📞 تماس با ما](https://www.google.com/search?q=%23-get-in-touch)

-----

## 🚀 فلسفه پروژه

هدف ما ساختن چیزی فراتر از یک "تستر" ساده بود. ما ابزاری را هدف قرار دادیم که **قدرتمند، مقیاس‌پذیر و امن** باشد. ما بر اساس چهار اصل اصلی هدایت می‌شویم:

1.  **ماژولار بودن (Modularity):** هر بخش از برنامه وظیفه‌ی مشخصی دارد. این باعث می‌شود کد ساده‌تر فهمیده، نگهداری و گسترش داده شود.
2.  **کارایی (Performance):** ما از `asyncio` و چندنخی (multithreading) برای اجرای تعداد زیادی تست به صورت همزمان و بدون فریز کردن رابط کاربری استفاده می‌کنیم. سرعت یک ویژگی است.
3.  **امنیت (Security):** ما کورکورانه به کانفیگ‌های اینترنتی اعتماد نمی‌کنیم. هر URI و کانفیگ برای جلوگیری از اجرای کدهای مخرب، اعتبارسنجی می‌شود.
4.  **تجربه کاربری (User Experience):** ما دو رابط کاربری غنی ارائه می‌دهیم—یک رابط گرافیکی با **PyQt6** و یک رابط ترمینال زیبا با **Rich**—تا نیاز هر نوع کاربری را برآورده کنیم.

-----

## 🏗️ معماری سطح بالا

برنامه به صورت لایه‌ای ساخته شده تا مسئولیت‌ها از هم جدا شوند و کد تمیز و قابل مدیریت باشد.

```
+--------------------------------+
|           لایه رابط کاربری (UI)        |
|  (MainWindow / CLIDashboard)   |
+--------------------------------+
                  ^
                  | (Signals/Slots, Callbacks)
                  v
+--------------------------------+
|          منطق برنامه            |
| (BackendWorker, TestOrchestrator)|
+--------------------------------+
                  ^
                  | (Async Tasks, Thread Pool)
                  v
+--------------------------------+
|       موتور اصلی تست            |
| (ConfigProcessor, TestRunner)  |
+--------------------------------+
                  ^
                  | (Subprocess Call)
                  v
+--------------------------------+
|    هسته Xray (xray.exe)         |
+--------------------------------+
```

-----

## 🧩 بررسی عمیق اجزای اصلی

در ادامه، جزئیات کلاس‌های کلیدی و وظایف آن‌ها آمده است.

| کلاس/ماژول | نقش و مسئولیت |
| :--- | :--- |
| `EnterpriseConfig` | **مغز متفکر.** تمام تنظیمات برنامه را مدیریت می‌کند، از آدرس‌های تست گرفته تا منابع کانفیگ و اطلاعات تلگرام. |
| `AppState` | **وضعیت سراسری.** یک مکان متمرکز برای پیگیری وضعیت فعلی برنامه (در حال اجرا، پیشرفت، نتایج و غیره). |
| `NetworkManager` | **متخصص شبکه.** تمام درخواست‌های شبکه (`aiohttp`) را با منطق تلاش مجدد (retry) و پشتیبانی از DoH مدیریت می‌کند. |
| `SecurityValidator` | **نگهبان امنیتی.** URIها و کانفیگ‌های JSON را برای جلوگیری از کدهای مخرب و آدرس‌های موجود در لیست سیاه، اعتبارسنجی می‌کند. |
| `ConfigProcessor` | **موتور کانفیگ.** قلب منطق پردازش. به طرز ماهرانه‌ای انواع طرح‌های URI را به فرمت کامل JSON که برای Xray قابل فهم است، تبدیل می‌کند. |
| `ConfigDiscoverer`| **کاشف منابع.** لیست کانفیگ‌ها را از لینک‌های جمع‌آوری‌کننده و منابع اشتراک مستقیم پیدا و دریافت می‌کند. |
| `TestRunner` | **اجراکننده تست.** فرآیند Xray را اجرا کرده و مجموعه‌ای از تست‌ها (پینگ، سرعت، عبور از فیلتر) را روی یک کانفیگ واحد اجرا می‌کند. |
| `TestOrchestrator`| **رهبر ارکستر.** کل خط لوله تست را مدیریت می‌کند، از ایجاد صف کانفیگ‌ها تا مدیریت استخر کارگرها (worker pool). |
| `BackendWorker` | **بهترین دوست رابط گرافیکی.** کل خط لوله تست را در یک `QThread` جداگانه اجرا می‌کند تا رابط کاربری روان و پاسخگو بماند. |
| `MainWindow` | **رابط کاربری گرافیکی.** پنجره اصلی برنامه که با PyQt6 ساخته شده و تمام تعاملات کاربر و نمایش داده‌ها را مدیریت می‌کند. |
| `CLIDashboard` | **رابط کاربری ترمینال.** یک رابط خط فرمان زیبا و کاربردی که توسط کتابخانه `Rich` قدرت گرفته است. |
| `TelegramManager` | **پیام‌رسان.** تمام تعاملات با ربات تلگرام را مدیریت می‌کند، از رسیدگی به دستورات تا ارسال نتایج. |

-----

## 🛠️ راه‌اندازی محیط توسعه

آماده‌اید دست به کار شوید؟ در ادامه نحوه راه‌اندازی آمده است.

1.  **پیش‌نیازها:**

      * Git
      * Python 3.8+
      * `venv` یا `conda` برای مدیریت محیط مجازی (بسیار توصیه می‌شود).

2.  **کلون کردن شاخه توسعه:**
    مطمئن شوید که روی شاخه `developer-mode` کار می‌کنید که حاوی آخرین سورس‌کد است.

    ```bash
    git clone --branch developer-mode https://github.com/Shayanthn/V2ray-Tester-Pro.git
    cd V2ray-Tester-Pro
    ```

3.  **ایجاد محیط مجازی:**

      * **استفاده از `venv` (توصیه شده):**
        ```bash
        python -m venv venv
        # در ویندوز
        .\venv\Scripts\activate
        # در macOS/Linux
        source venv/bin/activate
        ```

4.  **نصب وابستگی‌ها:**
    ما یک فایل `requirements.txt` برای ساده‌سازی این فرآیند قرار داده‌ایم.

    ```bash
    pip install -r requirements.txt
    ```

    > **نکته:** اگر این فایل وجود نداشت، می‌توانید آن را با محتوای زیر ایجاد کنید:
    > `aiohttp, psutil, requests, python-dotenv, PyQt6, rich, python-telegram-bot`

5.  **دریافت هسته Xray:**
    آخرین نسخه باینری هسته Xray را از [صفحه رسمی انتشارات Xray-core](https://github.com/XTLS/Xray-core/releases) دانلود کنید. فایل اجرایی را در پوشه اصلی پروژه قرار دهید و نام آن را `xray.exe` (برای ویندوز) یا `xray` (برای لینوکس/macOS) بگذارید.

6.  **(اختیاری) ایجاد فایل `.env`:**
    برای استفاده از ویژگی‌هایی مانند ربات تلگرام، یک فایل `.env` در پوشه اصلی پروژه ایجاد کنید. می‌توانید محتویات فایل `.env.example` (اگر وجود دارد) را کپی کنید یا از الگوی زیر استفاده کنید.

    ```env
    # فایل .env برای توسعه محلی

    # توکن ربات تلگرام از BotFather
    TELEGRAM_BOT_TOKEN="YOUR_TELEGRAM_BOT_TOKEN"

    # شناسه کاربری تلگرام شما برای دستورات ادمین
    TELEGRAM_ADMIN_ID="YOUR_TELEGRAM_ADMIN_ID"

    # لیست شناسه‌های کانال/کاربر برای ارسال نتایج (جدا شده با کاما)
    TELEGRAM_TARGET_IDS="@your_channel,12345678"
    ```

شما آماده‌اید\! برنامه را اجرا کنید:

  * `python main.py` برای رابط کاربری گرافیکی.
  * `python main.py --cli` برای رابط کاربری ترمینال.

-----

## 🔄 گردش کار تست

درک جریان داده کلید اصلی برای دیباگ کردن و توسعه برنامه است.

1.  **`TestOrchestrator.run_test_pipeline()`** برای شروع فراخوانی می‌شود.
2.  **کشف (`ConfigDiscoverer`):** تمام لینک‌های اشتراک را از منابع مستقیم و جمع‌آوری‌کننده‌ها جمع‌آوری می‌کند.
3.  **دریافت و صف‌بندی (`_fetch_and_queue_configs`):** تمام کانفیگ‌ها را دانلود و رمزگشایی کرده، آن‌ها را از نظر امنیتی (`SecurityValidator`) بررسی می‌کند و موارد امن را به یک `asyncio.Queue` اضافه می‌کند.
4.  **ایجاد کارگرها (`_run_workers`):** یک استخر از تسک‌های کارگر برای پردازش همزمان صف ایجاد می‌شود.
5.  **پردازش یک URI (`_worker`):**
      * یک URI از صف برداشته می‌شود.
      * `ConfigProcessor` آن URI را به یک کانفیگ کامل JSON برای Xray تبدیل می‌کند.
      * `TestRunner` این JSON را در یک فایل موقت ذخیره کرده، فرآیند `xray.exe` را با آن اجرا می‌کند و تست‌های پینگ/سرعت را از طریق پروکسی SOCKS محلی انجام می‌دهد.
      * یک دیکشنری حاوی نتایج بازگردانده می‌شود.
6.  **پردازش نتیجه:**
      * موقعیت جغرافیایی سرور (GeoIP) دریافت می‌شود.
      * نتیجه نهایی از طریق یک سیگنال PyQt (`result_ready`) به رابط کاربری ارسال می‌شود.
      * آمار کلی در `AppState` به‌روزرسانی می‌شود.
7.  **پایان:** پس از خالی شدن صف، کارگرها متوقف می‌شوند و نتایج نهایی ذخیره یا ارسال می‌شوند.

-----

## 🧠 مفاهیم کلیدی و الگوهای طراحی

  * **ورودی/خروجی ناهمزمان (`asyncio`):** ما از `asyncio` برای تمام عملیات وابسته به شبکه (دانلود کانفیگ‌ها، جستجوی DoH، دریافت اطلاعات GeoIP) استفاده می‌کنیم. این به برنامه اجازه می‌دهد صدها وظیفه ورودی/خروجی را بدون انتظار مدیریت کند و کارایی را به شدت افزایش دهد.
  * **چندنخی و همزمانی:**
      * **`QThread`:** کلاس `BackendWorker` کل حلقه رویداد `asyncio` را روی یک نخ جداگانه اجرا می‌کند تا اطمینان حاصل شود که رابط کاربری حتی تحت بار سنگین هرگز فریز نمی‌شود.
      * **`ThreadPoolExecutor`:** ما از یک استخر نخ برای اجرای تابع همزمان و مسدودکننده `TestRunner` از درون کد ناهمزمان خود استفاده می‌کنیم. این یک الگوی کلاسیک برای ادغام کد مسدودکننده در یک برنامه `asyncio` است.
      * **`subprocess.Popen`:** هسته Xray به عنوان یک فرآیند کاملاً مجزا اجرا می‌شود که تمیزترین و قابل‌اطمینان‌ترین راه برای مدیریت آن است.
  * **الگوی Observer:** مکانیسم **Signals & Slots** در PyQt6 یک پیاده‌سازی فوق‌العاده از این الگو است. بک‌اند (`BackendWorker`) سیگنال‌هایی مانند `update_status` یا `result_ready` را *منتشر* می‌کند بدون اینکه چیزی درباره رابط کاربری بداند. فرانت‌اند (`MainWindow`) در این سیگنال‌ها *مشترک* می‌شود و خود را بر اساس آن‌ها به‌روز می‌کند. این جداسازی، کد را فوق‌العاده تمیز می‌کند.

-----

## 🤝 چگونه مشارکت کنیم

مشارکت‌ها چیزی است که جامعه متن‌باز را شگفت‌انگیز می‌کند. ما از هر کمکی استقبال می‌کنیم\!

1.  **گزارش باگ:** مشکلی پیدا کردید؟ یک ایشو (issue) جدید در بخش [GitHub Issues](https://www.google.com/search?q=https://github.com/Shayanthn/V2ray-Tester-Pro/issues) باز کنید. لطفاً تا حد امکان جزئیات ارائه دهید.
2.  **پیشنهاد بهبود:** ایده خوبی دارید؟ یک ایشو باز کنید و بیایید در مورد آن صحبت کنیم.
3.  **ارسال Pull Request:**
      * ریپازیتوری را فورک (fork) کنید.
      * یک شاخه ویژگی (feature branch) جدید بسازید: `git checkout -b feature/your-cool-feature`
      * تغییرات خود را اعمال کرده و با یک پیام کامیت واضح، آن‌ها را ثبت کنید.
      * تغییرات را به فورک خود پوش (push) کرده و یک **Pull Request** به شاخه `developer-mode` ما ارسال کنید.

-----

## 🗺️ نقشه راه آینده

ما برنامه‌های بزرگی داریم\! در اینجا برخی از ایده‌هایی که در حال بررسی آن‌ها هستیم، آمده است. با خیال راحت یکی از آن‌ها را انتخاب کرده و مشارکت کنید\!

  * [ ] **پشتیبانی از پروتکل‌های بیشتر:** افزودن پارسر برای سایر پروتکل‌های نوظهور.
  * [ ] **تحلیل پیشرفته:** پیاده‌سازی نمودار و گراف برای بصری‌سازی نتایج تست در طول زمان.
  * [ ] **سیستم پلاگین:** امکان نوشتن ماژول‌های تست یا خروجی‌گیرهای نتایج توسط توسعه‌دهندگان.
  * [ ] **CI/CD با GitHub Actions:** خودکارسازی فرآیند ساخت و انتشار فایل `.exe` برای ویندوز، macOS و لینوکس.
  * [ ] **پشتیبانی بهتر از تم تاریک/روشن:** بهبود تم‌بندی رابط کاربری گرافیکی.

-----

## 📞 تماس با ما

سوالی دارید، می‌خواهید همکاری کنید یا فقط می‌خواهید سلامی بکنید؟ خوشحال می‌شوم از شما بشنوم.

  * **وب‌سایت:** [shayantaherkhani.ir](https://shayantaherkhani.ir)
  * **ایمیل:** [shayanthn78@gmail.com](mailto:shayanthn78@gmail.com) | [admin@shayantaherkhani.ir](mailto:admin@shayantaherkhani.ir)

ممنون که بخشی از این پروژه هستید. بیایید با هم چیزی شگفت‌انگیز بسازیم\! ❤️
